<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Navigateur</title>
  <style>
    /* Th√®me sombre inspir√© de Nouvel onglet */
    html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif;background:#000;color:#e8eaed}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;border-bottom:1px solid rgba(255,255,255,0.03);background:transparent}
    .left-controls{display:flex;gap:8px;align-items:center}
    .addr-input{padding:8px 10px;border:1px solid rgba(255,255,255,0.06);border-radius:20px;width:420px;background:rgba(255,255,255,0.02);color:#e8eaed}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:6px;color:#e8eaed;cursor:pointer}
    .btn:disabled{opacity:0.4;cursor:default}

    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:40px 20px}
    .logo{font-size:72px;color:#fff;font-weight:600;letter-spacing:2px}
    .search-large{width:640px;max-width:90%;display:flex;gap:8px}
    .search-input{flex:1;padding:14px 18px;border-radius:24px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-size:16px;color:#202124}
    .search-btn{padding:12px 18px;border-radius:20px;border:1px solid rgba(0,0,0,0.06);background:#fff;color:#202124;cursor:pointer}

    /* Shortcuts (petites ic√¥nes sous la barre) */
    .shortcuts{display:flex;gap:18px;margin-top:12px}
    .shortcut-wrap{display:flex;flex-direction:column;align-items:center}
    .shortcut{width:64px;height:64px;border-radius:50%;background:#1a73e8;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,0.6);cursor:pointer}
    .shortcut-label{font-size:12px;color:#9aa0a6;margin-top:6px;text-align:center}

    .content{display:none;height:calc(100vh - 64px);padding:0;margin:0}
    .content.active{display:block;height:calc(100vh - 64px)}
    iframe{border:none;width:100%;height:100%;background:#fff}

    .footer{height:40px;display:flex;align-items:center;justify-content:center;color:#9aa0a6;font-size:13px}

    /* Recherche locale (desktop) */
    .search-results { position:absolute; top:56px; left:260px; right:20px; background:#0b0b0c; border:1px solid rgba(255,255,255,0.03); border-radius:8px; max-height:260px; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,0.6); z-index:30; }
    @media (max-width:700px){ .search-results{ left:20px; right:20px; top:110px } }
    .search-item { padding:10px; border-bottom:1px solid rgba(255,255,255,0.03); cursor:pointer; }
    .search-item:last-child{ border-bottom:none }
    .search-item:hover{ background:rgba(255,255,255,0.02); }
    .search-title{ font-weight:600; color:#e8eaed }
    .search-desc{ color:#9aa0a6; font-size:13px; margin-top:4px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left-controls">
      <button class="btn" id="back">‚óÄ</button>
      <button class="btn" id="forward">‚ñ∂</button>
      <button class="btn" id="home">üè†</button>
      <input id="address" class="addr-input" placeholder="Entrez une adresse (ex: https://La Page)" aria-label="Barre d'adresse">
      <button id="addrGo" class="btn">Aller</button>
    </div>
    <div class="right-controls">
      <button id="showSearch" class="btn" title="Afficher recherche">üîé</button>
      <button id="reload" class="btn">‚ü≥</button>
    </div>
  </div>

  <div class="center">
    <div class="logo">Mini</div>
    <div class="hint" style="color:#9aa0a6">Recherchez dans les pages locales</div>
    <div class="search-large">
      <input id="mainSearch" class="search-input" placeholder="Rechercher (ex: lebon)">
      <button id="searchBtn" class="search-btn">Recherche</button>
    </div>

    <div class="shortcuts" style="margin-top:12px">
      <div class="shortcut-wrap">
        <a class="shortcut" href="pages/le-bon-coin.html" title="Le Bon Coin">LB</a>
        <div class="shortcut-label">Le Bon Coin</div>
      </div>
      <div class="shortcut-wrap">
        <a class="shortcut" href="pages/home.html" title="Accueil">H</a>
        <div class="shortcut-label">Accueil</div>
      </div>
    </div>
  </div>

  <div class="content">
    <iframe id="navigateur" src=""></iframe>
  </div>

  <div class="footer" id="footer">Navigation limit√©e aux pages locales</div>

  <script>
    // Comportement: barre du haut = adresses pr√©cises (ouvrir page locale)
    // champ central = recherche non pr√©cise => si 1 r√©sultat ouvrir la page, sinon ouvrir page de r√©sultats

    const iframe = document.getElementById('navigateur');
    const address = document.getElementById('address');
    const addrGo = document.getElementById('addrGo');
    const backBtn = document.getElementById('back');
    const forwardBtn = document.getElementById('forward');
    const homeBtn = document.getElementById('home');
    const reloadBtn = document.getElementById('reload');
    const mainSearch = document.getElementById('mainSearch');
    const searchBtn = document.getElementById('searchBtn');
    const footer = document.getElementById('footer');

    const DEFAULT_HOME = 'pages/home.html';
    let historyStack = [];
    let historyIndex = -1;

    // pagesIndex will be loaded from pages/pages.json (auto-generated). Keep a small fallback.
    let pagesIndex = [];
    async function loadPagesIndex(){
      try{
        const res = await fetch('pages/pages.json');
        if (res.ok){ pagesIndex = await res.json(); }
        else { throw new Error('fetch failed'); }
      }catch(e){
        // fallback if pages.json not available
        pagesIndex = [
          { url: 'pages/home.html', title: 'Accueil', display: 'https://lapage', keywords: 'accueil home', desc: "Page d'\'accueil" },
          { url: 'pages/le-bon-coin.html', title: 'Le Bon Coin', display: 'https://leboncoin', keywords: 'lebon boncoin annonces', desc: 'Exemple: site d\'annonces (factice)' }
        ];
      }
    }
    // start loading the index now
    loadPagesIndex();

    // R√©solution d'une entr√©e utilisateur (adresse ou display) vers l'URL locale r√©elle
    function getPageByInput(input){
      if (!input) return null;
      let t = input.trim().toLowerCase();
      // strip scheme if present (https:// etc.)
      t = t.replace(/^https?:\/\//, '').replace(/^\/\//, '').replace(/\/$/, '');
      // correspondance par display exact (ex: https://lapage -> lapage)
      const byDisplay = pagesIndex.find(p => ((p.display||'').toLowerCase().replace(/^https?:\/\//,'').replace(/\/$/,'') === t));
      if (byDisplay) return byDisplay;
      // correspondance par title exact
      const byTitle = pagesIndex.find(p => (p.title||'').toLowerCase() === t);
      if (byTitle) return byTitle;
      // correspondance par url exacte ou suffixe (pages/home.html)
      const byUrl = pagesIndex.find(p => p.url.toLowerCase() === t || t.endsWith(p.url.toLowerCase()) || p.url.toLowerCase().endsWith(t));
      if (byUrl) return byUrl;
      return null;
    }

    function isExternal(url){
      return /(^[a-z]+:)|(^\/\/)|([a-z0-9-]+\.[a-z]{2,})/i.test(url) && !url.startsWith('pages/');
    }

    function allowedLocal(url){
      if(!url) return false;
      // si la r√©solution renvoie une page connue => autoris√©
      const p = getPageByInput(url);
      if (p) return true;
      // chemin local pages/
      url = url.trim();
      if (url.startsWith('pages/') && url.toLowerCase().endsWith('.html')) return true;
      return false;
    }

    function navigate(url, add=true){
      if(!url) return;
      const input = url.trim();
      if (isExternal(input) && !allowedLocal(input)) { showMessage('‚ö†Ô∏è Acc√®s externe refus√©'); return; }

      const page = getPageByInput(input);
      let target, visible;
      if (page){
        target = page.url;
        visible = page.display || page.title;
      } else if (input.startsWith('pages/') && input.toLowerCase().endsWith('.html')){
        target = input;
        // cr√©er une URL visible r√©aliste √† partir du nom de fichier
        const parts = input.split('/');
        const name = parts[parts.length-1].split('.').slice(0, -1).join('.');
        visible = 'https://' + name.charAt(0).toUpperCase() + name.slice(1);
      } else {
        showMessage('Adresse non autoris√©e (seules pages locales)',4000);
        return;
      }

      // afficher la page dans la zone principale (masquer la barre centrale)
      showPageView(true);
      iframe.src = target;
      // normalize visible to lowercase host-like string (no spaces)
      address.value = (visible || '').toString().toLowerCase().replace(/\s+/g,'');

      if (add) { historyStack = historyStack.slice(0, historyIndex+1); historyStack.push(target); historyIndex = historyStack.length - 1; }
      updateNavButtons();
    }

    function updateNavButtons(){
      backBtn.disabled = historyIndex <= 0;
      forwardBtn.disabled = historyIndex >= historyStack.length -1 || historyIndex === -1;
    }

    function showMessage(msg, time=3000){
      footer.textContent = msg;
      setTimeout(()=> footer.textContent = 'Navigation limit√©e aux pages locales', time);
    }

    function searchLocal(q){
      q = (q||'').trim().toLowerCase();
      if(!q) return [];
      return pagesIndex.map(p => ({p,score:((p.title||'').toLowerCase().includes(q)?3:0)+((p.keywords||'').toLowerCase().includes(q)?2:0)+((p.desc||'').toLowerCase().includes(q)?1:0)+((p.url||'').toLowerCase().includes(q)?1:0)})).filter(r => r.score>0).sort((a,b)=>b.score-a.score).map(r=>r.p);
    }

    // Vue : bascule entre la page d'accueil (centre visible) et la vue page (iframe plein)
    const centerEl = document.querySelector('.center');
    const contentEl = document.querySelector('.content');
    function showPageView(show = true){
      if (show){
        centerEl.style.display = 'none';
        contentEl.classList.add('active');
      } else {
        centerEl.style.display = 'flex';
        contentEl.classList.remove('active');
      }
    }

    // Top address handlers (pr√©cise)
    addrGo.addEventListener('click', ()=>{
      const v = address.value.trim();
      if(!v) return;
      const page = getPageByInput(v);
      if (page) navigate(page.url, true);
      else if (v.startsWith('pages/') && v.toLowerCase().endsWith('.html')) navigate(v, true);
      else showMessage('Adresse non autoris√©e (seules pages locales)',4000);
    });
    address.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addrGo.click(); });

    // Recherche centrale (non pr√©cise)
    searchBtn.addEventListener('click', ()=>{
      const q = mainSearch.value.trim();
      if(!q) return;
      const results = searchLocal(q);
      if (results.length===1){ navigate(results[0].url, true); }
      else {
        // ouvrir la page de r√©sultats et transmettre la query
        navigate('pages/search-results.html?q='+encodeURIComponent(q), true);
      }
    });
    mainSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchBtn.click(); });

    // Shortcuts (assurent la navigation dans l'iframe)
    document.querySelectorAll('.shortcut').forEach(el => {
      el.addEventListener('click', (e)=>{ e.preventDefault(); const url = el.getAttribute('href'); navigate(url, true); });
    });

    // Bouton pour revenir √† la recherche centrale
    const showSearchBtn = document.getElementById('showSearch');
    if (showSearchBtn){ showSearchBtn.addEventListener('click', ()=>{ showPageView(false); const m = document.getElementById('mainSearch'); if (m) m.focus(); }); }
    // Navigation buttons
    backBtn.addEventListener('click', ()=>{ if(historyIndex>0){ historyIndex--; navigate(historyStack[historyIndex], false); } });
    forwardBtn.addEventListener('click', ()=>{ if(historyIndex < historyStack.length -1){ historyIndex++; navigate(historyStack[historyIndex], false); } });
    homeBtn.addEventListener('click', ()=>{ navigate(DEFAULT_HOME, true); });
    reloadBtn.addEventListener('click', ()=>{ try{ iframe.contentWindow.location.reload(); }catch(e){ iframe.src = iframe.src; } });

    // Mettre √† jour le champ adresse quand l'iframe change (local only) ‚Äî affiche la display URL si connue
    iframe.addEventListener('load', ()=>{
      try{
        const current = iframe.contentWindow.location.href;
        // trouver la page dont l'URL appara√Æt dans la location
        const found = pagesIndex.find(p => current.toLowerCase().includes(p.url.toLowerCase()));
        if (found){
          address.value = found.display || found.title;
        } else if (current.startsWith('file:')){
          const parts = current.split('/');
          const last = parts.slice(-2).join('/');
          // essayer d'extraire un mapping connu
          const byLast = pagesIndex.find(p => last.toLowerCase().endsWith(p.url.toLowerCase().split('/').pop()));
          if (byLast) address.value = byLast.display || byLast.title;
          else address.value = last;
        } else {
          address.value = current;
        }
      }catch(e){ /* cross-origin - ignore */ }
    });

    // Initial state: afficher la barre de recherche centrale, pas de navigation automatique
  </script>
</body>
</html>
